
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>final_patient_monitor_server &#8212; Patient Monitoring Client/Server  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for final_patient_monitor_server</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pymongo.errors</span>
<span class="kn">from</span> <span class="nn">database_definition</span> <span class="kn">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">pymodm</span> <span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">pymodm</span> <span class="kn">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">pymodm_errors</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="server_on"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.server_on">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">server_on</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Indicate server status</span>

<span class="sd">    This route is a simple route to indicate that the server is on</span>

<span class="sd">    Returns:</span>
<span class="sd">        &#39;Server is on&#39; (str): a simple string to indicate that the server is on</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;Server is on&#39;</span></div>


<span class="c1"># **************************Junqi Lu starts**************************</span>


<div class="viewcode-block" id="get_database_connect_status_handler"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.get_database_connect_status_handler">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/monitor/database_connect_status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_database_connect_status_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Handler function that checks on the connection of the database</span>

<span class="sd">    This handler function calls on init_database() to try to connect to a</span>
<span class="sd">    database and return responses to the client to indicate the status of</span>
<span class="sd">    the connection</span>

<span class="sd">    Returns:</span>
<span class="sd">        jsonify(msg) (jsonified str): jsonified &#39;Successfully connected</span>
<span class="sd">    to the database&#39; if the database is successfully connected and &#39;Failed</span>
<span class="sd">    to connect to the database&#39; if not</span>

<span class="sd">        status (int): this is the value to indicate the database connection</span>
<span class="sd">        status. 200 if the database is successfully connected and 400 if not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database_connection_str</span> <span class="o">=</span> \
        <span class="s2">&quot;mongodb+srv://davidhe:Davidhe1998@cluster0.grsdcun.mongodb.net&quot;</span> \
        <span class="s2">&quot;/Final_project?retryWrites=true&amp;w=majority&quot;</span>  <span class="c1"># This is the formal</span>
    <span class="c1"># final project database</span>
    <span class="c1"># database_connection_str = \</span>
    <span class="c1">#     &quot;mongodb+srv://davidhe:Davidhe1998@cluster0.grsdcun.mongodb.net&quot; \</span>
    <span class="c1">#     &quot;/dummy_dataset?retryWrites=true&amp;w=majority&quot;  # This is the</span>
    <span class="c1"># # dummy_dataset for development. This will be commented out in the final</span>
    <span class="c1"># # code</span>

    <span class="n">msg</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">init_database</span><span class="p">(</span><span class="n">database_connection_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">status</span></div>


<div class="viewcode-block" id="init_database"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.init_database">[docs]</a><span class="k">def</span> <span class="nf">init_database</span><span class="p">(</span><span class="n">database_connection_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the databases by trying to connect to a MongoDB database</span>

<span class="sd">    This function is the real worker function that simply connects to a</span>
<span class="sd">    database in</span>
<span class="sd">    MongoDB using a try-except</span>
<span class="sd">    block by the database_connection_str. It will return corresponding</span>
<span class="sd">    messages and status code to indicate the connection status to the database</span>

<span class="sd">    Args:</span>
<span class="sd">        database_connection_str (str): the connection str obtained from</span>
<span class="sd">        mongodb to connect to a specific database</span>

<span class="sd">    Returns:</span>
<span class="sd">        msg (str): &#39;Successfully connected to the database&#39; if the</span>
<span class="sd">    database is successfully connected and &#39;Failed to connect to the</span>
<span class="sd">    database&#39; if not</span>

<span class="sd">        status (int): this is the value to indicate the database connection</span>
<span class="sd">        status. 200 if the database is successfully connected and 400 if not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">database_connection_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Failed to connect to the database&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Successfully connected to the database&#39;</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span></div>


<div class="viewcode-block" id="get_all_med_number_handler"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.get_all_med_number_handler">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/monitor/all_med_number&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_all_med_number_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Obtain all the medical record numbers in the connected database</span>

<span class="sd">    This function is the handler of the route &#39;/api/monitor/all_med_number&#39;.</span>
<span class="sd">    It first calls on a function that judges whether the connected database</span>
<span class="sd">    is empty, and then calls on get_all_med_number_worker() that will obtain</span>
<span class="sd">    all the record number if there&#39;s at least 1 or [&#39;Database is empty. Add</span>
<span class="sd">    in data from patient GUI first&#39;] if there&#39;s none. Finally, it returns</span>
<span class="sd">    the obtained record number list back to the client with the status code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        jsonify(all_med_number_list): all_med_number_list will be a list</span>
<span class="sd">        that contains all the medical record number in the database or</span>
<span class="sd">        simply [&#39;Database is empty. Add in data from patient GUI first&#39;] if</span>
<span class="sd">        the database has no record at all. It will be jsonified to send</span>
<span class="sd">        back to the client</span>
<span class="sd">        status (int): 200 if the database has at least 1 record; 400 if the</span>
<span class="sd">        database has no records at all</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># You do not have to test the Flask handler functions directly</span>

    <span class="c1"># Since there&#39;s no input data, this route&#39;s handler start from complete</span>
    <span class="c1"># tasks</span>
    <span class="n">empty_db_judgement</span> <span class="o">=</span> <span class="n">empty_db_judge</span><span class="p">()</span>
    <span class="n">all_med_number_list</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">get_all_med_number_worker</span><span class="p">(</span>
        <span class="n">empty_db_judgement</span><span class="p">)</span>

    <span class="c1"># Return the JSON str and status code back to requestor</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">all_med_number_list</span><span class="p">),</span> <span class="n">status</span></div>


<div class="viewcode-block" id="get_all_med_number_worker"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.get_all_med_number_worker">[docs]</a><span class="k">def</span> <span class="nf">get_all_med_number_worker</span><span class="p">(</span><span class="n">empty_db_judgement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The real working function that obtain all the medical record number</span>
<span class="sd">    in the database</span>

<span class="sd">    Based on the empty_db_judgement, this function decides whether to simply</span>
<span class="sd">    return [&#39;Database is empty. Add in data from patient GUI first&#39;],</span>
<span class="sd">    400 to indicate the database is empty or to iterate through all the</span>
<span class="sd">    record numbers in the database to make a list and return that list with</span>
<span class="sd">    200</span>

<span class="sd">    Returns:</span>
<span class="sd">        med_number_list (list of int): if the database contains at</span>
<span class="sd">    least 1 record number, it contains all the record number in the type of</span>
<span class="sd">    int; if the database is empty, then this will be [&#39;Database is empty.</span>
<span class="sd">    Add in data from patient GUI &#39; &#39;first&#39;]</span>

<span class="sd">        status (int): 200 if the database has at least 1 record; 400 if the</span>
<span class="sd">        database has no records at all</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">med_number_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">empty_db_judgement</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">med_number_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Database is empty. Add in data from patient GUI &#39;</span>
                           <span class="s1">&#39;first&#39;</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">Patient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">({}):</span>
            <span class="n">med_number</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">medical_record_number</span>
            <span class="n">med_number_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">med_number</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">return</span> <span class="n">med_number_list</span><span class="p">,</span> <span class="n">status</span></div>


<div class="viewcode-block" id="empty_db_judge"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.empty_db_judge">[docs]</a><span class="k">def</span> <span class="nf">empty_db_judge</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Judges whether a conencted database is empty</span>

<span class="sd">    This function iterates through all the entries in the connected database</span>
<span class="sd">    to count out the number of entries. If the number of entry is 0,</span>
<span class="sd">    it returns True to indicate the connected database is empty and false if</span>
<span class="sd">    it is not empty</span>

<span class="sd">    Returns:</span>
<span class="sd">        True or False (bool): the judgement of whether the connected</span>
<span class="sd">        database is empty. True if empty and False if not empty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">Patient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">({}):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,):</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Consider a non-working database pretty much the same</span>
        <span class="c1"># as an empty database</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="retrieve_patient_info_handler"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.retrieve_patient_info_handler">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/monitor/patient_info/&lt;record_number&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_patient_info_handler</span><span class="p">(</span><span class="n">record_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recieve record number from route request and return the patient info</span>
<span class="sd">    based on that record number</span>

<span class="sd">    This function is the handler of the route</span>
<span class="sd">    &#39;/api/monitor/patient_info/&lt;record_number&gt;&#39;. It first receives input</span>
<span class="sd">    record number from the request. Then with supporting functions,</span>
<span class="sd">    it returns the found patient info dict from the database. Note that this</span>
<span class="sd">    route will only used by an GUI that asks user to select a record number</span>
<span class="sd">    from available record number inside the database. Since the patient info</span>
<span class="sd">    input GUI has already checked the data type of record number as int,</span>
<span class="sd">    this route doesn&#39;t check again on whether that record number exist in</span>
<span class="sd">    the database and whether it is an int--both are guuarnteed by the</span>
<span class="sd">    patient info input GUI.</span>

<span class="sd">    Args:</span>
<span class="sd">        record_number (int): a unique int that distinguishes a patient&#39;s</span>
<span class="sd">        entry from others&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        jsonify(all_med_number_list): all_med_number_list will be a list</span>
<span class="sd">        that contains all the medical record number in the database or</span>
<span class="sd">        simply [&#39;Database is empty. Add in data from patient GUI first&#39;] if</span>
<span class="sd">        the database has no record at all. It will be jsonified to send</span>
<span class="sd">        back to the client</span>
<span class="sd">        status (int): 200 if the database has at least 1 record; 400 if the</span>
<span class="sd">        database has no records at all</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># You do not have to test the Flask handler functions directly</span>

    <span class="c1"># No value judgement is needed since record_number is selected by the user</span>
    <span class="c1"># from the database (users not allowed to type anything), and we have</span>
    <span class="c1"># data validation at the patient</span>
    <span class="c1"># GUI to</span>
    <span class="c1"># ensure record_number follows the correct data type.</span>

    <span class="n">patient_info_dict</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">retrieve_patient_info_worker</span><span class="p">(</span><span class="n">record_number</span><span class="p">)</span>

    <span class="c1"># Return the JSON str and status code back to requestor</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">patient_info_dict</span><span class="p">),</span> <span class="n">status</span></div>


<div class="viewcode-block" id="retrieve_patient_info_worker"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.retrieve_patient_info_worker">[docs]</a><span class="k">def</span> <span class="nf">retrieve_patient_info_worker</span><span class="p">(</span><span class="n">record_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The real working function that obtain the patient info by the given</span>
<span class="sd">    record number</span>

<span class="sd">    Based on the given record_number, this function uses a try-except block</span>
<span class="sd">    to go through all the records and try to obtain the patinet info based</span>
<span class="sd">    on the given record number.</span>

<span class="sd">    Args:</span>
<span class="sd">        record_number (int): a unique int that distinguishes a patient&#39;s</span>
<span class="sd">        entry from others&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        output (str or dict): can be &#39;Something is wrong&#39; if the searching</span>
<span class="sd">        run into some issues or patient_info_dict if the corresponding</span>
<span class="sd">        patient info dict was found by the given record number. If a dict,</span>
<span class="sd">        the format for output will be {</span>
<span class="sd">    medical_record_number: int, patient_name: str, heart_rate_history: {</span>
<span class="sd">    timestmap_str: int}, ecg_image_history: {timestmap_str: b64_str},</span>
<span class="sd">    medical_filename_history: {timestmap_str: filename_str},</span>
<span class="sd">    medical_image_history: {timestmap_str: b64_str}}</span>

<span class="sd">        status (int): 200 if the corresponding info dict was successfully</span>
<span class="sd">        obtained; 400 if the searching was not successful</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">record_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">record_number</span><span class="p">)</span>
    <span class="n">patient_info_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">Patient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">record_number</span><span class="p">}):</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;medical_record_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">medical_record_number</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;patient_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">patient_name</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;heart_rate_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">heart_rate_history</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;ecg_image_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">ecg_image_history</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;medical_filename_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">medical_filename_history</span>
            <span class="n">patient_info_dict</span><span class="p">[</span>
                <span class="s1">&#39;medical_image_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">medical_image_history</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;Something is wrong&#39;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Since patient wil only make a selection from a list of all the</span>
        <span class="c1"># record number in the database, if the request was made with a</span>
        <span class="c1"># non-existing record number, this will return patient_info_dict as</span>
        <span class="c1"># {} but still a status code 200. But this case will never happen if</span>
        <span class="c1"># the user makes requests through GUI only</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">patient_info_dict</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">status</span></div>


<span class="c1"># **************************Junqi Lu ends**************************</span>

<span class="c1"># **************************Ramana Balla starts**************************</span>
<span class="c1"># **************************Ramana Balla ends**************************</span>

<span class="c1"># **************************Ziwei He starts**************************</span>


<div class="viewcode-block" id="upload_handler"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.upload_handler">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/patient_GUI/upload/&lt;warn&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload_handler</span><span class="p">(</span><span class="n">warn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Upload patient information handler</span>

<span class="sd">    Accept patient information upload. The patient information should be</span>
<span class="sd">    formatted as below:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;patient_record_no&quot;: &lt;int&gt; (mandatory)</span>
<span class="sd">            &quot;patient_name&quot;: &lt;str&gt; (blank if not provide)</span>
<span class="sd">            &quot;medical_img&quot;: &lt;b64str&gt; (blank if not provide)</span>
<span class="sd">            &quot;img_filename&quot;: &lt;str&gt; (blank if not provide)</span>
<span class="sd">            &quot;ECG_img&quot;: &lt;b64str&gt; (blank if not provide)</span>
<span class="sd">            &quot;heart_rate&quot;: &lt;str&gt; (blank if not provide)</span>
<span class="sd">        }</span>
<span class="sd">    The &lt;warn&gt; parameter indicates if the user wants to overwrite data. &quot;true&quot;</span>
<span class="sd">    means overwrite. Otherwise, the parameter is &quot;false&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        warn (string): &quot;true&quot; if the user confirms overwriting. Otherwise, it</span>
<span class="sd">        is &quot;false&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        msg (string): Status message.</span>
<span class="sd">        status (integer): status code.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">in_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">msg</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">info_process</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="n">warn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span></div>


<div class="viewcode-block" id="info_process"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.info_process">[docs]</a><span class="k">def</span> <span class="nf">info_process</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="n">warn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process the patient information and return the result of processing.</span>

<span class="sd">    This function checks for the existing information of a record number in the</span>
<span class="sd">    database. If no record found, the information will be stored in the</span>
<span class="sd">    database. If there is existing record, this function updates the record</span>
<span class="sd">    unless the name in the record is different from the one provided by the</span>
<span class="sd">    user. Confirmation of the user is required to update the name in the</span>
<span class="sd">    database.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_data (dictionary): Patient information in the format of:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;patient_record_no&quot;: &lt;int&gt; (mandatory),</span>
<span class="sd">                &quot;patient_name&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">                &quot;medical_img&quot;: &lt;b64str&gt; (blank if not provide),</span>
<span class="sd">                &quot;img_filename&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">                &quot;ECG_img&quot;: &lt;b64str&gt; (blank if not provide),</span>
<span class="sd">                &quot;heart_rate&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">            }</span>
<span class="sd">        warn (string): &quot;true&quot; if the user confirms overwriting. Otherwise, it</span>
<span class="sd">        is &quot;false&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        msg (string): Status message.</span>
<span class="sd">        status (integer): status code.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">warn</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">]})</span><span class="o">.</span> \
                <span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">patient_name</span> <span class="o">!=</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">patient_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Need confirmation for overwriting old name&quot;</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
                    <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">save_info</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">201</span>
                    <span class="k">if</span> <span class="p">[</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">],</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">],</span>
                            <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No information need to be updated&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Successfully update the information of &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;patient </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">save_info</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">[</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">],</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]]</span> <span class="o">==</span> \
                        <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No information need to be updated&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Successfully update the information of patient </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">])</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">201</span>
                <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span>
        <span class="k">except</span> <span class="n">pymodm_errors</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">save_info</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Successfully upload the patient information&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">201</span>
            <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ServerSelectionTimeoutError</span><span class="p">,</span>
                <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ConnectionFailure</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fail to connect to the database&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">save_info</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Name updated&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Successfully update the information of patient </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span> \
                <span class="nb">format</span><span class="p">(</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">])</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">201</span>
        <span class="k">return</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span></div>


<div class="viewcode-block" id="save_info"><a class="viewcode-back" href="../Docs/final_patient_monitor_server.html#final_patient_monitor_server.save_info">[docs]</a><span class="k">def</span> <span class="nf">save_info</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="n">first_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save information in the database.</span>

<span class="sd">    This function creates new entry in the database and updates existing entry</span>
<span class="sd">    based on the uploaded information</span>

<span class="sd">    Args:</span>
<span class="sd">        in_data (dictionary): Patient information in the format of:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;patient_record_no&quot;: &lt;int&gt; (mandatory),</span>
<span class="sd">                &quot;patient_name&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">                &quot;medical_img&quot;: &lt;b64str&gt; (blank if not provide),</span>
<span class="sd">                &quot;img_filename&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">                &quot;ECG_img&quot;: &lt;b64str&gt; (blank if not provide),</span>
<span class="sd">                &quot;heart_rate&quot;: &lt;str&gt; (blank if not provide),</span>
<span class="sd">            }</span>
<span class="sd">        first_record (boolean): True if there is no existing record in the</span>
<span class="sd">        database for the uploaded information. False if there is existing</span>
<span class="sd">        record for the uploaded information.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">]})</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_record</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">Patient</span><span class="p">(</span><span class="n">medical_record_number</span><span class="o">=</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_record_no&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">patient_name</span> <span class="o">=</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">medical_img</span> <span class="o">=</span> <span class="p">{</span><span class="n">timestamp</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]}</span>
            <span class="n">img_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">timestamp</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;img_filename&quot;</span><span class="p">]}</span>
            <span class="n">info</span><span class="o">.</span><span class="n">medical_filename_history</span> <span class="o">=</span> <span class="n">img_name</span>
            <span class="n">info</span><span class="o">.</span><span class="n">medical_image_history</span> <span class="o">=</span> <span class="n">medical_img</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ECG</span> <span class="o">=</span> <span class="p">{</span><span class="n">timestamp</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">]}</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="p">{</span><span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;heart_rate&quot;</span><span class="p">])}</span>
            <span class="n">info</span><span class="o">.</span><span class="n">ecg_image_history</span> <span class="o">=</span> <span class="n">ECG</span>
            <span class="n">info</span><span class="o">.</span><span class="n">heart_rate_history</span> <span class="o">=</span> <span class="n">hr</span>
        <span class="n">info</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;patient_name&quot;</span><span class="p">:</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]}})</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;medical_image_history.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                         <span class="nb">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;medical_img&quot;</span><span class="p">]}})</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;medical_filename_history.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                         <span class="nb">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
                                       <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;img_filename&quot;</span><span class="p">]}})</span>
        <span class="k">if</span> <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ecg_image_history.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
                                   <span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;ECG_img&quot;</span><span class="p">]}})</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;heart_rate_history.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">in_data</span><span class="p">[</span><span class="s2">&quot;heart_rate&quot;</span><span class="p">])}})</span></div>
<span class="c1"># **************************Ziwei He ends**************************</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">database_connection_str</span> <span class="o">=</span> \
        <span class="s2">&quot;mongodb+srv://davidhe:Davidhe1998@cluster0.grsdcun.mongodb.net&quot;</span> \
        <span class="s2">&quot;/Final_project?retryWrites=true&amp;w=majority&quot;</span>  <span class="c1"># This is the formal</span>
    <span class="c1"># final project database</span>

    <span class="n">connect</span><span class="p">(</span><span class="n">database_connection_str</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>  <span class="c1"># Remote server</span>
    <span class="c1"># app.run()  # Local server</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Patient Monitoring Client/Server</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Ziwei He, Junqi Lu, Ramana Balla.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>